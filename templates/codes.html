{% extends "base.html" %}

{% block title %}Коды - Админка UC Bot{% endblock %}

{% block content %}
<div class="codes-page">
    <div class="page-header">
        <h2>
            {% if table == 'codes' %}
                Коды
            {% elif table == 'used_codes' %}
                Использованные коды
            {% elif table == 'given_codes' %}
                Отданные коды
            {% endif %}
        </h2>
        <a href="{{ url_for('add_code', table=table) }}" class="btn btn-success">Добавить код</a>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>UC</th>
                    <th>Код</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% if codes %}
                    {% for code in codes %}
                        <tr>
                            <td>{{ code.id }}</td>
                            <td><span class="uc-badge">{{ code.val }}</span></td>
                            <td><code class="code-text">{{ code.code }}</code></td>
                            <td class="actions">
                                <a href="{{ url_for('edit_code', code_id=code.id, table=table) }}" class="btn btn-sm btn-warning">Редактировать</a>
                                <button onclick="deleteCode({{ code.id }}, '{{ table }}')" class="btn btn-sm btn-danger">Удалить</button>
                                {% if table == 'codes' %}
                                    <button onclick="moveCode({{ code.id }}, 'codes', 'used_codes')" class="btn btn-sm btn-info">→ Использованные</button>
                                    <button onclick="moveCode({{ code.id }}, 'codes', 'given_codes')" class="btn btn-sm btn-info">→ Отданные</button>
                                {% elif table == 'used_codes' %}
                                    <button onclick="moveCode({{ code.id }}, 'used_codes', 'codes')" class="btn btn-sm btn-info">→ Коды</button>
                                    <button onclick="moveCode({{ code.id }}, 'used_codes', 'given_codes')" class="btn btn-sm btn-info">→ Отданные</button>
                                {% elif table == 'given_codes' %}
                                    <button onclick="moveCode({{ code.id }}, 'given_codes', 'codes')" class="btn btn-sm btn-info">→ Коды</button>
                                    <button onclick="moveCode({{ code.id }}, 'given_codes', 'used_codes')" class="btn btn-sm btn-info">→ Использованные</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="text-center">Нет данных</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
function deleteCode(codeId, table) {
    if (!confirm('Вы уверены, что хотите удалить этот код?')) {
        return;
    }
    
    fetch(`/codes/delete/${codeId}?table=${table}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function moveCode(codeId, fromTable, toTable) {
    if (!confirm(`Перенести код из "${fromTable}" в "${toTable}"?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('code_id', codeId);
    formData.append('from_table', fromTable);
    formData.append('to_table', toTable);
    
    fetch('/codes/move', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}
</script>
{% endblock %}
